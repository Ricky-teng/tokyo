<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>東京相簿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- 導覽列 -->
<nav class="bg-white border-b shadow fixed top-0 left-0 w-full z-50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
    <h1 class="text-xl font-bold text-blue-600">東京相簿</h1>
    <ul class="flex space-x-4 text-sm font-medium">
      <li><a href="index.html" class="hover:text-blue-600">首頁</a></li>
      <li><a href="album.html" class="text-blue-600">相簿</a></li>
    </ul>
  </div>
</nav>

<main class="pt-24 max-w-5xl mx-auto px-4">
  <!-- 上傳 -->
  <div class="flex items-center justify-between mb-4">
    <input type="file" id="uploadInput" multiple class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:border file:rounded file:text-sm file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
    <button onclick="handleUpload()" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">上傳</button>
  </div>

  <!-- 排序選單 -->
  <div class="flex justify-end mb-4">
    <label for="sortSelect" class="mr-2 text-gray-700">排序方式：</label>
    <select id="sortSelect" class="border rounded px-2 py-1 text-sm">
      <option value="newest">由新到舊</option>
      <option value="oldest">由舊到新</option>
      <option value="likes">喜愛程度</option>
    </select>
  </div>

  <!-- loading 圈 -->
  <div id="loading" class="flex justify-center items-center py-12 hidden">
    <svg class="animate-spin h-8 w-8 text-blue-600" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" />
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
    </svg>
  </div>

  <!-- 相片牆 -->
  <div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</main>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
    authDomain: "tokyo-14278.firebaseapp.com",
    projectId: "tokyo-14278"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const photosRef = db.collection("photos");

  const deletePassword = "123"; // 自定義刪除密碼

  document.getElementById("sortSelect").addEventListener("change", loadPhotos);

  async function loadPhotos() {
    const container = document.getElementById("photoContainer");
    const loading = document.getElementById("loading");
    container.innerHTML = "";
    loading.classList.remove("hidden");

    const sort = document.getElementById("sortSelect").value;
    let query = photosRef;

    if (sort === "newest") query = query.orderBy("timestamp", "desc");
    else if (sort === "oldest") query = query.orderBy("timestamp", "asc");
    else if (sort === "likes") query = query.orderBy("like", "desc");

    const snapshot = await query.get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const url = data.url;
      const like = data.like || 0;

      const box = document.createElement("div");
      box.className = "relative group border rounded overflow-hidden shadow bg-white";

      box.innerHTML = `
        <img src="${url}" class="w-full h-64 object-cover"/>
        <div class="absolute top-2 right-2 flex space-x-2 opacity-0 group-hover:opacity-100 transition">
          <button class="likeBtn bg-white rounded px-2 py-1 text-sm shadow">❤️ ${like}</button>
          <button class="deleteBtn bg-white rounded px-2 py-1 text-sm shadow">🗑️</button>
          <a href="${url}" download class="bg-white rounded px-2 py-1 text-sm shadow">⬇️</a>
        </div>
      `;

      box.querySelector(".likeBtn").addEventListener("click", async () => {
        await photosRef.doc(doc.id).update({ like: like + 1 });
        loadPhotos();
      });

      box.querySelector(".deleteBtn").addEventListener("click", () => {
        const input = prompt("請輸入刪除密碼");
        if (input !== deletePassword) return alert("密碼錯誤！");
        if (confirm("確定刪除這張圖片嗎？")) {
          photosRef.doc(doc.id).delete().then(loadPhotos);
        }
      });

      container.appendChild(box);
    });

    loading.classList.add("hidden");
  }

  async function handleUpload() {
    const files = document.getElementById("uploadInput").files;
    if (!files.length) return alert("請選擇圖片");

    for (const file of files) {
      const options = { maxSizeMB: 1, maxWidthOrHeight: 1280, useWebWorker: true };
      const compressed = await imageCompression(file, options);

      const formData = new FormData();
      formData.append("file", compressed);
      formData.append("upload_preset", "tokyo_album");

      const res = await fetch("https://api.cloudinary.com/v1_1/dd2lnjt52/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      await photosRef.add({
        url: data.secure_url,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        like: 0
      });
    }

    document.getElementById("uploadInput").value = "";
    loadPhotos();
  }

  loadPhotos();
</script>
</body>
</html>
