<!-- trigger redeploy -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç›¸ç°¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- ä¸Šå‚³æŒ‰éˆ• -->
  <div class="my-4 text-center">
    <input type="file" id="uploadInput" multiple accept="image/*" class="mb-2" />
    <button onclick="handleUpload()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
      ä¸Šå‚³åœ–ç‰‡
    </button>
  </div>

  <!-- ç…§ç‰‡å®¹å™¨ -->
  <div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 px-4 pb-8"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
      authDomain: "tokyo-14278.firebaseapp.com",
      projectId: "tokyo-14278",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const photosRef = db.collection("photos");
    const deletePassword = "tokyo123";

    async function loadPhotos() {
      const container = document.getElementById("photoContainer");
      container.innerHTML = "";
      const snapshot = await photosRef.orderBy("timestamp", "desc").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        const photoBox = document.createElement("div");
        photoBox.className = "relative group border rounded overflow-hidden shadow";

        photoBox.innerHTML = `
          <img src="${data.url}" alt="photo" class="w-full h-64 object-cover" />
          <div class="absolute top-2 right-2">
            <button class="text-white bg-black bg-opacity-50 p-1 rounded-full hover:bg-opacity-70 focus:outline-none group">
              â‹®
            </button>
            <div class="hidden group-hover:block absolute right-0 mt-2 bg-white shadow rounded z-10">
              <button class="block px-4 py-2 text-sm hover:bg-gray-100 w-full text-left deleteBtn">ğŸ—‘ åˆªé™¤</button>
              <a href="${data.url}" download class="block px-4 py-2 text-sm hover:bg-gray-100">â¬‡ï¸ ä¸‹è¼‰</a>
            </div>
          </div>
        `;

        photoBox.querySelector(".deleteBtn").addEventListener("click", () => {
          const input = prompt("è«‹è¼¸å…¥åˆªé™¤å¯†ç¢¼");
          if (input !== deletePassword) {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤ï¼");
            return;
          }
          if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ")) {
            photosRef.doc(doc.id).delete().then(loadPhotos);
          }
        });

        container.appendChild(photoBox);
      });
    }

    async function handleUpload() {
      const files = document.getElementById("uploadInput").files;
      if (!files.length) return alert("è«‹é¸æ“‡åœ–ç‰‡");

      for (const file of files) {
        const options = {
          maxSizeMB: 1,
          maxWidthOrHeight: 1280,
          useWebWorker: true
        };
        const compressed = await imageCompression(file, options);

        const formData = new FormData();
        formData.append("file", compressed);
        formData.append("upload_preset", "tokyo_album");

        const res = await fetch("https://api.cloudinary.com/v1_1/dd2lnjt52/image/upload", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        await photosRef.add({
          url: data.secure_url,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      loadPhotos();
      document.getElementById("uploadInput").value = "";
    }

    loadPhotos();
  </script>
</body>
</html>
