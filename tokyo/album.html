<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>相簿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4 text-center">📸 東京旅遊相簿</h1>

    <!-- 上傳區塊 -->
    <div class="mb-6 text-center">
      <input type="file" id="fileInput" accept="image/*" multiple class="block mx-auto mb-2" />
      <button onclick="uploadImages()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">上傳照片</button>
    </div>

    <!-- 相片牆 -->
    <div id="photoGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
      authDomain: "tokyo-14278.firebaseapp.com",
      projectId: "tokyo-14278",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const photosRef = db.collection("photos");

    const cloudName = "dd2lnjt52";
    const uploadPreset = "tokyo_album";

    async function uploadImages() {
      const files = document.getElementById("fileInput").files;
      if (!files.length) return;

      for (const file of files) {
        const compressed = await imageCompression(file, {
          maxSizeMB: 10,
          useWebWorker: true
        });

        const formData = new FormData();
        formData.append("file", compressed);
        formData.append("upload_preset", uploadPreset);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        if (data.secure_url) {
          await photosRef.add({
            url: data.secure_url,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }

      loadPhotos(); // 重新載入
    }

    async function loadPhotos() {
      const photoGrid = document.getElementById("photoGrid");
      photoGrid.innerHTML = "";

      const snapshot = await photosRef.orderBy("createdAt", "desc").get();
      snapshot.forEach(doc => {
        const { url } = doc.data();
        const id = doc.id;

        const container = document.createElement("div");
        container.className = "relative group";

        const img = document.createElement("img");
        img.src = url;
        img.className = "rounded shadow w-full h-auto";

        // 三點按鈕
        const menuBtn = document.createElement("button");
        menuBtn.innerHTML = "⋮";
        menuBtn.className = "absolute top-1 right-1 bg-white rounded-full p-1 shadow hover:bg-gray-200";
        menuBtn.onclick = () => {
          const menu = document.getElementById(`menu-${id}`);
          menu.classList.toggle("hidden");
        };

        // 選單
        const menu = document.createElement("div");
        menu.id = `menu-${id}`;
        menu.className = "hidden absolute top-8 right-1 bg-white border rounded shadow z-10";
        menu.innerHTML = `
          <button class="block w-full px-4 py-2 text-left hover:bg-gray-100" onclick="downloadImage('${url}')">下載</button>
          <button class="block w-full px-4 py-2 text-left text-red-500 hover:bg-gray-100" onclick="deletePhoto('${id}')">刪除</button>
        `;

        container.appendChild(img);
        container.appendChild(menuBtn);
        container.appendChild(menu);
        photoGrid.appendChild(container);
      });
    }

    async function deletePhoto(id) {
      if (confirm("確定要刪除這張照片嗎？")) {
        await photosRef.doc(id).delete();
        loadPhotos();
      }
    }

    function downloadImage(url) {
      const link = document.createElement("a");
      link.href = url;
      link.download = "photo.jpg";
      link.click();
    }

    // 初始載入
    loadPhotos();
  </script>
</body>
</html>
