<!-- trigger redeploy -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç›¸ç°¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
<!-- ä¸Šå‚³æŒ‰éˆ•å€åŸŸ -->
<div class="my-4">
  <input type="file" id="uploadInput" multiple accept="image/*" class="mb-2" />
  <button onclick="handleUpload()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
    ä¸Šå‚³åœ–ç‰‡
  </button>
</div>

<!-- é¡¯ç¤ºåœ–ç‰‡çš„å®¹å™¨ -->
<div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4 text-center">ğŸ“¸ æ±äº¬æ—…éŠç›¸ç°¿</h1>

    <!-- ä¸Šå‚³å€å¡Š -->
    <div class="mb-6 text-center">
      <input type="file" id="fileInput" accept="image/*" multiple class="block mx-auto mb-2" />
      <button onclick="uploadImages()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ä¸Šå‚³ç…§ç‰‡</button>
    </div>

    <!-- ç›¸ç‰‡ç‰† -->
    <div id="photoGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
      authDomain: "tokyo-14278.firebaseapp.com",
      projectId: "tokyo-14278",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const photosRef = db.collection("photos");

    const cloudName = "dd2lnjt52";
    const uploadPreset = "tokyo_album";

    async function uploadImages() {
      const files = document.getElementById("fileInput").files;
      if (!files.length) return;

      for (const file of files) {
        const compressed = await imageCompression(file, {
          maxSizeMB: 10,
          useWebWorker: true
        });

        const formData = new FormData();
        formData.append("file", compressed);
        formData.append("upload_preset", uploadPreset);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        if (data.secure_url) {
          await photosRef.add({
            url: data.secure_url,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }

      loadPhotos(); // é‡æ–°è¼‰å…¥
    }

    async function loadPhotos() {
      const photoGrid = document.getElementById("photoGrid");
      photoGrid.innerHTML = "";

      const snapshot = await photosRef.orderBy("createdAt", "desc").get();
      snapshot.forEach(doc => {
        const { url } = doc.data();
        const id = doc.id;

        const container = document.createElement("div");
        container.className = "relative group";

        const img = document.createElement("img");
        img.src = url;
        img.className = "rounded shadow w-full h-auto";

        // ä¸‰é»æŒ‰éˆ•
        const menuBtn = document.createElement("button");
        menuBtn.innerHTML = "â‹®";
        menuBtn.className = "absolute top-1 right-1 bg-white rounded-full p-1 shadow hover:bg-gray-200";
        menuBtn.onclick = () => {
          const menu = document.getElementById(`menu-${id}`);
          menu.classList.toggle("hidden");
        };

        // é¸å–®
        const menu = document.createElement("div");
        menu.id = `menu-${id}`;
        menu.className = "hidden absolute top-8 right-1 bg-white border rounded shadow z-10";
        menu.innerHTML = `
          <button class="block w-full px-4 py-2 text-left hover:bg-gray-100" onclick="downloadImage('${url}')">ä¸‹è¼‰</button>
          <button class="block w-full px-4 py-2 text-left text-red-500 hover:bg-gray-100" onclick="deletePhoto('${id}')">åˆªé™¤</button>
        `;

        container.appendChild(img);
        container.appendChild(menuBtn);
        container.appendChild(menu);
        photoGrid.appendChild(container);
      });
    }

    async function deletePhoto(id) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) {
        await photosRef.doc(id).delete();
        loadPhotos();
      }
    }

    function downloadImage(url) {
      const link = document.createElement("a");
      link.href = url;
      link.download = "photo.jpg";
      link.click();
    }

    // åˆå§‹è¼‰å…¥
    loadPhotos();
  </script>
  <script type="module">
  import imageCompression from "https://cdn.skypack.dev/browser-image-compression";

  const firebaseConfig = {
    apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
    authDomain: "tokyo-14278.firebaseapp.com",
    projectId: "tokyo-14278",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const photosRef = db.collection("photos");

  const deletePassword = "tokyo123"; // ğŸ›¡ï¸ ä½ å¯ä»¥æ›æ‰å¯†ç¢¼

  async function loadPhotos() {
    const container = document.getElementById("photoContainer");
    container.innerHTML = "";
    const snapshot = await photosRef.orderBy("timestamp", "desc").get();

    snapshot.forEach(doc => {
      const data = doc.data();
      const photoBox = document.createElement("div");
      photoBox.className = "relative group border rounded overflow-hidden shadow";

      photoBox.innerHTML = `
        <img src="${data.url}" alt="photo" class="w-full h-64 object-cover" />
        <div class="absolute top-2 right-2">
          <button class="text-white bg-black bg-opacity-50 p-1 rounded-full hover:bg-opacity-70 focus:outline-none group">
            â‹®
          </button>
          <div class="hidden group-hover:block absolute right-0 mt-2 bg-white shadow rounded z-10">
            <button class="block px-4 py-2 text-sm hover:bg-gray-100 w-full text-left deleteBtn">ğŸ—‘ åˆªé™¤</button>
            <a href="${data.url}" download class="block px-4 py-2 text-sm hover:bg-gray-100">â¬‡ï¸ ä¸‹è¼‰</a>
          </div>
        </div>
      `;

      photoBox.querySelector(".deleteBtn").addEventListener("click", () => {
        const input = prompt("è«‹è¼¸å…¥åˆªé™¤å¯†ç¢¼");
        if (input !== deletePassword) {
          alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤ï¼");
          return;
        }
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å¼µåœ–ç‰‡å—ï¼Ÿ")) {
          photosRef.doc(doc.id).delete().then(loadPhotos);
        }
      });

      container.appendChild(photoBox);
    });
  }

  async function handleUpload() {
    const files = document.getElementById("uploadInput").files;
    if (!files.length) return alert("è«‹é¸æ“‡åœ–ç‰‡");

    for (const file of files) {
      const options = {
        maxSizeMB: 1,
        maxWidthOrHeight: 1280,
        useWebWorker: true
      };
      const compressed = await imageCompression(file, options);

      const formData = new FormData();
      formData.append("file", compressed);
      formData.append("upload_preset", "tokyo_album");

      const res = await fetch("https://api.cloudinary.com/v1_1/dd2lnjt52/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      await photosRef.add({ url: data.secure_url, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    }

    loadPhotos();
    document.getElementById("uploadInput").value = ""; // æ¸…ç©º
  }

  loadPhotos();
</script>

</body>
</html>
