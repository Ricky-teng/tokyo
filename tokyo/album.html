<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>旅行相簿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/1.0.16/browser-image-compression.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">

<!-- Navbar -->
<nav class="bg-white shadow p-4 fixed top-0 left-0 w-full z-50 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-600">東京相簿</h1>
  <div class="flex items-center space-x-4">
    <input id="uploadInput" type="file" accept="image/*" multiple class="hidden">
    <button onclick="document.getElementById('uploadInput').click()" class="bg-blue-500 text-white px-3 py-1 rounded">上傳照片</button>

    <select id="sortSelect" class="border rounded px-2 py-1 text-sm">
      <option value="newest">由新到舊</option>
      <option value="oldest">由舊到新</option>
      <option value="likes">喜愛程度</option>
    </select>
  </div>
</nav>

<!-- Main content -->
<main class="pt-24 max-w-5xl mx-auto px-4">
  <div id="progressText" class="text-center my-2 text-sm text-gray-600 hidden">上傳中...</div>
  <div id="spinner" class="flex justify-center my-4 hidden">
    <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
  </div>
  <div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
</main>

<script>
  // Firebase init
  const firebaseConfig = {
    // 請填入你的 Firebase 設定
    apiKey: "...",
    authDomain: "...",
    projectId: "tokyo",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const photosRef = db.collection("photos");

  const deletePassword = "1234"; // 🔒 自定刪除密碼
  let currentSort = "newest";

  document.getElementById("sortSelect").addEventListener("change", (e) => {
    currentSort = e.target.value;
    loadPhotos();
  });

  // ⬆️ 上傳圖片（支援多張）
  async function handleUpload() {
    const files = document.getElementById("uploadInput").files;
    if (!files.length) return alert("請選擇圖片");

    document.getElementById("progressText").classList.remove("hidden");
    document.getElementById("spinner").classList.remove("hidden");

    for (const file of files) {
      const options = { maxSizeMB: 1, maxWidthOrHeight: 1280, useWebWorker: true };
      const compressed = await imageCompression(file, options);

      const formData = new FormData();
      formData.append("file", compressed);
      formData.append("upload_preset", "tokyo_album");

      const res = await fetch("https://api.cloudinary.com/v1_1/dd2lnjt52/image/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();

      await photosRef.add({
        url: data.secure_url,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        like: 0
      });
    }

    document.getElementById("progressText").classList.add("hidden");
    document.getElementById("spinner").classList.add("hidden");
    document.getElementById("uploadInput").value = "";
    loadPhotos();
  }

  // 📷 載入圖片
  async function loadPhotos() {
    const container = document.getElementById("photoContainer");
    container.innerHTML = "";

    let query = photosRef;
    if (currentSort === "newest") {
      query = query.orderBy("timestamp", "desc");
    } else if (currentSort === "oldest") {
      query = query.orderBy("timestamp", "asc");
    } else if (currentSort === "likes") {
      query = query.orderBy("like", "desc");
    }

    const snapshot = await query.get();
    snapshot.forEach((doc) => {
      const { url, like = 0, timestamp } = doc.data();
      const photoBox = document.createElement("div");
      photoBox.className = "relative bg-white rounded shadow";

      photoBox.innerHTML = `
        <img src="${url}" alt="photo" class="w-full h-64 object-cover rounded-t">
        <div class="absolute top-2 right-2 flex space-x-1">
          <button class="menuBtn bg-white rounded px-2 py-1 text-sm shadow">⋮</button>
          <div class="menu hidden flex-col bg-white rounded shadow text-sm absolute top-8 right-0 z-10">
            <button class="deleteBtn px-3 py-2 hover:bg-gray-100">🗑️ 刪除</button>
            <button class="downloadBtn px-3 py-2 hover:bg-gray-100">⬇️ 下載</button>
          </div>
        </div>
        <div class="flex justify-between items-center px-4 py-2">
          <button class="likeBtn text-xl">${like} ❤️</button>
        </div>
      `;

      // ❤️ 喜歡
      photoBox.querySelector(".likeBtn").addEventListener("click", () => {
        photosRef.doc(doc.id).update({ like: firebase.firestore.FieldValue.increment(1) });
        loadPhotos();
      });

      // 🗑️ 刪除
      photoBox.querySelector(".deleteBtn").addEventListener("click", () => {
        const input = prompt("請輸入刪除密碼");
        if (input !== deletePassword) {
          alert("密碼錯誤，無法刪除！");
          return;
        }
        if (confirm("確定要刪除這張圖片嗎？")) {
          photosRef.doc(doc.id).delete().then(loadPhotos);
        }
      });

      // ⬇️ 下載（自定義檔名）
      photoBox.querySelector(".downloadBtn").addEventListener("click", () => {
        const filename = `tokyo_${doc.id}.jpg`;
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // ⋮ 控制選單
      const menuBtn = photoBox.querySelector(".menuBtn");
      const menu = photoBox.querySelector(".menu");
      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("hidden");
      });
      document.addEventListener("click", () => menu.classList.add("hidden"));

      container.appendChild(photoBox);
    });
  }

  document.getElementById("uploadInput").addEventListener("change", handleUpload);
  loadPhotos();
</script>
</body>
</html>
