<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>個人資料設定</title>
 <script type="module">
// ...Firebase 初始化不變...

function compressImage(file, maxWidth = 600, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target.result;
    };
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob((blob) => {
        if (blob) {
          resolve(new File([blob], file.name, { type: "image/jpeg" }));
        } else {
          reject("壓縮失敗");
        }
      }, "image/jpeg", quality);
    };
    reader.readAsDataURL(file);
  });
}

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (file) {
    preview.src = URL.createObjectURL(file);
    selectedFile = await compressImage(file); // ⬅️ 壓縮後的圖片
  }
});

saveBtn.addEventListener("click", async () => {
  statusText.textContent = "儲存中...";
  let photoURL = currentUser.photoURL;

  if (selectedFile) {
    try {
      const formData = new FormData();
      formData.append("file", selectedFile);
      formData.append("upload_preset", "tokyo_album");
      formData.append("folder", "tokyo-trip");

      const res = await fetch("https://api.cloudinary.com/v1_1/dd2lnjt52/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.secure_url) {
        photoURL = data.secure_url;
      } else {
        throw new Error("Cloudinary 上傳失敗");
      }
    } catch (error) {
      console.error(error);
      statusText.textContent = "儲存失敗：Cloudinary 上傳失敗";
      return;
    }
  }

  try {
    await updateProfile(currentUser, {
      displayName: displayNameInput.value,
      photoURL: photoURL
    });
    statusText.textContent = "儲存成功！";
  } catch (error) {
    console.error(error);
    statusText.textContent = "儲存失敗：Firebase 更新失敗";
  }
});
</script>

</head>
<body>
  <h1>個人資料設定</h1>
  <label>顯示名稱</label>
  <input type="text" id="displayName" /><br><br>

  <label>大頭貼</label>
  <input type="file" id="avatar" accept="image/*" /><br>
  <img id="preview" src="" alt="大頭貼預覽" width="100" style="display:block;margin-top:10px;" /><br>

  <button id="saveBtn">儲存</button>
  <p id="status" style="color: green;"></p>
</body>
</html>
