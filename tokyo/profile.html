<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>設定個人檔案</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h2 class="text-2xl font-bold mb-4">設定個人檔案</h2>
    <label class="block mb-2">顯示名稱</label>
    <input id="displayName" type="text" class="w-full border rounded px-3 py-2 mb-4" placeholder="輸入顯示名稱" />

    <label class="block mb-2">上傳頭像圖片</label>
    <input id="avatarInput" type="file" accept="image/*" class="mb-4" />
    <img id="avatarPreview" src="" alt="預覽頭像" class="w-24 h-24 rounded-full object-cover mb-4" />

    <button id="saveBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">儲存</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
      authDomain: "tokyo-14278.firebaseapp.com",
      projectId: "tokyo-14278",
      storageBucket: "tokyo-14278.appspot.com",
      messagingSenderId: "831929477903",
      appId: "1:831929477903:web:02cfff17d8c6b4c29d6c7a",
      measurementId: "G-10T563NMRW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userId = null;
    let previousPage = document.referrer;

    const displayNameInput = document.getElementById('displayName');
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const saveBtn = document.getElementById('saveBtn');
    let uploadedAvatarUrl = null;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("請先登入");
        location.href = "index.html";
        return;
      }

      userId = user.uid;

      // 載入使用者資料
      const doc = await db.collection("users").doc(userId).get();
      if (doc.exists) {
        const data = doc.data();
        if (data.displayName) displayNameInput.value = data.displayName;
        if (data.photoURL) {
          avatarPreview.src = data.photoURL;
          uploadedAvatarUrl = data.photoURL;
        }
      }
    });

    avatarInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "tokyo_album");
      formData.append("cloud_name", "dd2lnjt52");

      try {
        const res = await fetch("https://api.cloudinary.com/v1_1/dd2lnjt52/image/upload", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("上傳失敗");

        const data = await res.json();
        uploadedAvatarUrl = data.secure_url;
        avatarPreview.src = uploadedAvatarUrl;
      } catch (err) {
        alert("圖片上傳錯誤：" + err.message);
      }
    });

    saveBtn.addEventListener("click", async () => {
      if (!userId) return;

      const displayName = displayNameInput.value.trim();
      await db.collection("users").doc(userId).set({
        displayName: displayName,
        photoURL: uploadedAvatarUrl || "",
      }, { merge: true });

      alert("儲存成功");
      if (previousPage) {
        window.location.href = previousPage;
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
