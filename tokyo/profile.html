<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>設定個人檔案</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFh075x68NVbXfkvlPv4wa3uNi-rilcEk",
      authDomain: "tokyo-14278.firebaseapp.com",
      projectId: "tokyo-14278",
      storageBucket: "tokyo-14278.appspot.com",
      messagingSenderId: "831929477903",
      appId: "1:831929477903:web:02cfff17d8c6b4c29d6c7a",
      measurementId: "G-10T563NMRW"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      auth.onAuthStateChanged(user => {
        if (!user) {
          alert("請先登入");
          window.location.href = "index.html";
          return;
        }

        // 預填使用者資訊
        document.getElementById("nameInput").value = user.displayName || "";
        if (user.photoURL) {
          document.getElementById("avatarPreview").src = user.photoURL;
        }

        // 處理按鈕
        document.getElementById("saveBtn").addEventListener("click", async () => {
          const newName = document.getElementById("nameInput").value.trim();
          const file = document.getElementById("avatarFile").files[0];

          if (!newName) {
            alert("請輸入名稱");
            return;
          }

          let photoURL = user.photoURL;

          try {
            if (file) {
              // 上傳圖片至 storage
              const snapshot = await storage.ref(`avatars/${user.uid}.jpg`).put(file);
              photoURL = await snapshot.ref.getDownloadURL();
              document.getElementById("avatarPreview").src = photoURL;
            }

            // 更新 Auth profile
            await user.updateProfile({
              displayName: newName,
              photoURL: photoURL
            });

            // 更新 Firestore
            await db.collection("users").doc(user.uid).set({
              displayName: newName,
              photoURL: photoURL,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            alert("已更新個人檔案！");
          } catch (err) {
            console.error("更新失敗", err);
            alert("更新失敗：" + err.message);
          }
        });
      });
    });
  </script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <div class="max-w-md mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">設定個人檔案</h1>

    <label class="block mb-2">顯示名稱</label>
    <input id="nameInput" class="w-full p-2 border mb-4" type="text" placeholder="輸入你的名字" />

    <label class="block mb-2">上傳頭像圖片</label>
    <input id="avatarFile" class="w-full p-2 border mb-2" type="file" accept="image/*" />
    <img id="avatarPreview" src="" alt="預覽頭像" class="w-24 h-24 object-cover rounded-full mb-4 border" />

    <button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">儲存</button>
  </div>
</body>
</html>
